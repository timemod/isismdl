---
title: "Introduction to package `isismdl`"
author: "Rob van Harrevelt"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
linkcolor: blue    
vignette: >
  %\VignetteIndexEntry{Introduction to package isismdl}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
---

<!--   
PREPARATIONS
-->
```{r echo = FALSE, message = FALSE}

library(isismdl)

# input/output chunks are separated
# R inputlines start with >, outputlines with nothing
knitr::opts_chunk$set(collapse = FALSE, comment = "", prompt = TRUE)
```

# Introduction

This introduction shows how package `isismdl` can be used to solve a simple example 
model, a dynamical version of the ISLM model.

[Here follows a description of the ISLM model]

# The model file

The model file should be defined on an external ASCII file. A detailed
discussion about the syntax of this file is provided in the Reference
Manual of Isis.

A model file for the ISLM model is included in the example models
in directory `models` of the package directory.
To copy this file to you working directory, use
```{r echo = FALSE, message = FALSE}
unlink("islm.mdl")
```
```{r results='hide'}
mdl_file <- system.file("models", "islm.mdl", package = "isismdl")
file.copy(mdl_file, "islm.mdl")
```

The model file `islm.mdl` has the following contents:
```{r echo = FALSE, comment=''}
cat(readLines('islm.mdl'), sep = '\n')
```

# Creating the  model

The function `isis_mdl` parses the model file and creates an `IsisMdl` object
```{r}
mdl <- isis_mdl("islm.mdl")
```

This function generates the file `islm.mrf`, the so called
model reference file (mrf file), a text file with information about
the structure of the model.
If the compiler detects an error in the model file, an additional
file `islm.err` is created. This file contains a list of errors.

The mrf file for our ISLM looks like this:

```{r echo = FALSE}
cat(readLines('islm.mrf'), sep = '\n')
```

The mrf file contains technical information about the model.
For example, it shows which variables are exogenous or endogenous,
and which variables are feedback variables. A brief explanation of these
concepts:

* Exogenous variables are variables that only occur at the right hand side of the equation.
* Endogenous variables are variables on the left hand side of the equations.
* A feedback variable is a variable that directly or indirectly depends on itself. In order to solve the model, initial guess values for the feedback variables have to be specified.

# `IsisMdl` objects

An `IsisMdl` object is an R6 class object. R6 
classes behave quite differently than the more familiar S3 and S4 classes. 
For example, for R6 classes methods are part of the object itself and not of 
generic functions. R6 classes behave in a similar way as classes in
object oriented languages such as Java, C++ or Python. 

For example, the method `get_params()` can be used to
obtain the values of the model parameters. 
For example, to obtains the values of parameters `m0` and `c1`, use
```{r}
mdl$get_param(names = c("m0", "c1"))
```

Methods starting with `get_`, are often called "getter" methods.
There are also corresponding "setter" methods. For example
```{r}
mdl$set_param(list(m0 = 100))
mdl$get_param("m0")
```
Input for method `set_params()` is a named list.

## Copying `IsisMdl` objects

Consider the following assignment:
```{r}
mdl2 <- mdl
```
Now variables `mdl2` and `mdl` refer to the same object. If you modify
`mdl2`, then also `mdl` is modified.
```{r}
mdl2$set_param(list(m0 = 75))
mdl$get_param("m0")
```
The usual copy-on-modify semantics that are used for convential
R objects such as S3 or S4 classes do not apply to R6 classes.

If you want to create a copy of the model, use the `copy()` method with
argument `deep = TRUE` :
```{r}
mdl2 <- mdl$copy()
mdl2$set_param(list(m0 = -9999))
mdl$get_param("m0")
```

# Solving the model \label{sec:solve}

Suppose that we want to solve the model for the period from `2017Q1` to
`2018Q2`. Then we need the values of the exogenous variables for that period.
For the feedback variables `y` and `r` we also need initial
starting values for the model period `2017Q1/2018Q2'.
Since `r`, `y` and `y_d` are lagged, we also need values for these
variables in `2016Q4`. 

In typical applications, the input timeseries are read
from an external file, for example a csv file. For this tutorial
we will create a timeseries object manually by employing
function `regts` of the `regts` package. For the exogenous variables
`g` and `ms` we assume an annual growth of 1.5% after `2016Q4`.
```{r}
# exogenous variables:
g  <- regts(210 * cumprod(rep(1.015, 6)), start = "2017Q1")
ms <- regts(200 * cumprod(rep(1.015, 6)), start = "2017Q1")
# feedback variables (with lag):
r <- regts(3.4, period = "2016Q4/2018Q2")
y <- regts(980, period = "2016Q4/2018Q2")
# lagged variable
yd <- regts(790, start = "2016Q4")
data <- cbind(g, ms, r, y, yd)
data
```

To transfer these variables to the model, we first
have to define the model period. This is the period for which the model will be 
solved. For this we use the
method `set_period()`:
```{r}
mdl$set_period(period_range("2017Q1", "2018Q2"))
mdl
```
The data period is the model period extended with the lag and lead period.
You can also retrieve the model period and model data period 
with the methods `get_period()` and `get_data_period`.

Now we can transfer the values in `regts` object data to the model
with method `set_data()`:
```{r}
mdl$set_data(data)
```

To check the model data, we use
```{r}
mdl$get_data()
```
Model variables that we have not explicitly set all value `NA`.
These values are not needed to solve the model.

We are now ready to solve the model:
```{r}
mdl$solve()
```

The method `get_data()` can be used to retrieve the solution.
```{r}
mdl$get_data()
```

# Writing and reading `IsisMdl` objects

To write an `IsisMdl`object to a file, use
```{r}
mdl$write_mdl(file = "islm_mdl.rds")
```

This methods serializes the model equations, parameters, model data, solve options, etc.
You can read this model back with the command
```{r, results = "hide"}
mdl <- read_mdl("islm_mdl.rds")
```

```{r, echo = FALSE, results = "hide"}
unlink("islm_mdl.rds")
```

Do not use the standard functions for writing objects to a file and to restore them,
such as `save`, `saveRDS`, `load` and `readRDS`. These functions cannot handle
the complex structure of `IsisMdl` objects.

# Fixing variables

TODO

<!-- There are two types of equations in Isis models: -->
<!-- the so called `frml` (formula) equations, also -->
<!-- called behavioural equations, and identities.  The frml equations -->

<!-- Endogenous variables that occur in the left hand side of frml equations -->

# The fit procedure

TODO

# Modellen bewerken

## Vergelijkingen uitschakelen

TODO

## Modeldata aanvullen

TODO

## Losse vergelijkingen draaien

# Bijsturen van het modeloplossen

TODO
